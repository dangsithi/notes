<!-- Chỉ cập nhật phần <script> trong index.html -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxuuYjmUledswIUOPrTGrPHtRl2FYov4_tUwpepieLTV0Y4vau4MzMObk9R6aOBfOaV/exec";
    let isRegisterMode = false;

    window.onload = function() {
        if (localStorage.getItem('loggedInUser') && localStorage.getItem('authToken')) {
            window.location.href = 'notes.html';
        }
    };

    function switchToRegister() {
        isRegisterMode = !isRegisterMode;
        document.getElementById('title').textContent = isRegisterMode ? 'Đăng Ký' : 'Đăng Nhập';
        document.getElementById('login-btn').textContent = isRegisterMode ? 'Đăng Ký' : 'Đăng Nhập';
        document.getElementById('switch-btn').textContent = isRegisterMode ? 'Đăng Nhập' : 'Đăng Ký';
        document.getElementById('message').textContent = '';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
    }

    async function login() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const message = document.getElementById('message');
        const loginBtn = document.getElementById('login-btn');

        if (!username || !password) {
            message.textContent = 'Vui lòng nhập đầy đủ thông tin!';
            return;
        }

        if (!/^[a-zA-Z0-9]+$/.test(username)) {
            message.textContent = 'Tên người dùng chỉ được chứa chữ cái và số!';
            return;
        }

        const hashedPassword = CryptoJS.SHA256(password).toString();
        const endpoint = isRegisterMode ? 'register' : 'login';
        message.textContent = isRegisterMode ? 'Đang đăng ký...' : 'Đang kiểm tra...';
        loginBtn.disabled = true;

        try {
            const response = await fetch(`${SCRIPT_URL}?action=${endpoint}`, {
                method: 'POST',
                body: JSON.stringify({ username, password: hashedPassword })
            });
            const data = await response.json();

            message.textContent = data.message;
            message.style.color = data.success ? 'green' : 'red';

            if (data.success && !isRegisterMode) {
                localStorage.setItem('loggedInUser', username);
                localStorage.setItem('authToken', data.authToken); // Lưu token
                window.location.href = 'notes.html';
            } else if (data.success && isRegisterMode) {
                switchToRegister();
            }
        } catch (error) {
            message.textContent = 'Lỗi kết nối: ' + error.message;
            message.style.color = 'red';
        } finally {
            loginBtn.disabled = false;
        }
    }

    function showLoggedInState(username) {
        window.location.href = 'notes.html';
    }

    function logout() {
        localStorage.removeItem('loggedInUser');
        localStorage.removeItem('authToken');
        location.reload();
    }
</script>