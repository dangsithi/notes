const SHEET_NAME = 'Sheet1';

function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const action = e.parameter.action;

  if (action === 'register') {
    return handleRegister(data, sheet);
  } else if (action === 'login') {
    return handleLogin(data, sheet);
  }

  return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'Hành động không hợp lệ!' }))
    .setMimeType(ContentService.MimeType.JSON);
}

function handleRegister(data, sheet) {
  const { username, password } = data;
  const users = sheet.getRange('A2:B').getValues().filter(row => row[0]);
  
  if (users.some(row => row[0] === username)) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'Tên người dùng đã tồn tại!' }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  sheet.appendRow([username, password]);
  return ContentService.createTextOutput(JSON.stringify({ success: true, message: 'Đăng ký thành công!' }))
    .setMimeType(ContentService.MimeType.JSON);
}

function handleLogin(data, sheet) {
  const { username, password } = data;
  const users = sheet.getRange('A2:B').getValues().filter(row => row[0]);
  const user = users.find(row => row[0] === username && row[1] === password);

  if (user) {
    return ContentService.createTextOutput(JSON.stringify({ success: true, message: 'Đăng nhập thành công!' }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'Tên người dùng hoặc mật khẩu sai!' }))
    .setMimeType(ContentService.MimeType.JSON);
}